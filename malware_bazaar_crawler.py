import requests
import pyzipper
import os

API_KEY = ''
ZIP_PASSWORD = b'infected'
headers = {'API-KEY': API_KEY}

data = {
    'query': 'get_file_type',
    'file_type': 'apk',
    'limit': 1000
}

response = requests.post('https://mb-api.abuse.ch/api/v1/', data=data, timeout=60, headers=headers)
response = response.json()['data']
files = [item for item in response if item['intelligence']['clamav']]
print(len(files))

for file in files:
    with open('./samples/malware_bazaar/bazaar_hashes.txt', 'r') as f:
        if file["md5_hash"] in f.read():
            print(f'File {file["md5_hash"]} already downloaded.')
            continue
    data = {
        'query': 'get_file',
        'sha256_hash': file['sha256_hash']
    }
    response = requests.post('https://mb-api.abuse.ch/api/v1/', data=data, timeout=60, headers=headers)
    if 'file_not_found' in response.text:
        print(f'Error: File {file["sha256_hash"]} not found')
        continue
    else:
        open(f'./samples/malware_bazaar/{file["md5_hash"]}.zip', 'wb').write(response.content)
        try:
            with pyzipper.AESZipFile(f'./samples/malware_bazaar/{file["md5_hash"]}.zip') as zf:
                zf.pwd = ZIP_PASSWORD
                zf.extractall('./samples/malware_bazaar')
            with open('./samples/malware_bazaar/bazaar_hashes.txt', 'a') as f:
                f.write(file["md5_hash"] + '\n')
        except Exception as e:
            print(e)
            continue
        os.remove(f'./samples/malware_bazaar/{file["md5_hash"]}.zip')
